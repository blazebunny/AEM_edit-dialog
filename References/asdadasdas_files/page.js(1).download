(function(window,undefined){window.Granite=window.Granite||{};window.Granite.author=window.Granite.author||{}})(this);(function(window,undefined){Granite.author.inner={};Granite.author.inner.EditorFrame=(new Granite.author.MessageChannel("cqauthor",window.parent)).mixin({})})(this);
(function(window,ns,undefined){ns.commands=ns.commands||{};var emulator;ns.AbstractCommand=ns.util.createClass({constructor:function(){},replace:function(path,msg){return false},replaceContent:function(path,msg){return false},insertBefore:function(path,msg){return false},insertAfter:function(path,msg){return false},insertLast:function(path,msg){return false},moveBefore:function(path,msg){return false},moveAfter:function(path,msg){return false},toggleClass:function(path,msg){return false},_toggleClassName:function(target,
cmd){if(!target)return;var hasClass=target.className.indexOf(cmd.className)!==-1;var appendClass=cmd.condition===false?false:cmd.condition===true?true:!hasClass;if(appendClass&&!hasClass)target.className+=" "+cmd.className;else if(!appendClass&&hasClass)target.className=target.className.replace(cmd.className,"")},emulate:function(path,msg){var cfg=msg.data,w=cfg.width;if(!emulator)emulator=new Granite.author.MediaEmulator(document);if(cfg.rotated){cfg.width=cfg.height;cfg.height=w}cfg=emulator.prepareDevice(cfg);
emulator.applyDevice(cfg);msg.respond("cqauthor-cmd",{cmdData:cfg});return false},resetEmulate:function(path,msg){if(!emulator)emulator=new Granite.author.MediaEmulator(document);emulator.restore()}});ns.AbstractCommand.prototype["delete"]=function(path,msg){return false}})(this,window.Granite.author);
(function(window,ns,undefined){ns.commands=ns.commands||{};var self=Granite.author;function manipulationEnd(){window.dispatchEvent(new CustomEvent("resize"))}function sanitize(code){try{eval(code)}catch(ex){console.error(ex)}}function loadScript(scriptNode){var newScript;if(scriptNode.parentNode){newScript=document.createElement("script");newScript.setAttribute("src",scriptNode.src);newScript.setAttribute("type",scriptNode.getAttribute("type")||"");newScript.setAttribute("charset",scriptNode.getAttribute("charset")||
"");newScript.setAttribute("onload",scriptNode.getAttribute("onload")||"");if(scriptNode.hasAttribute("async"))newScript.setAttribute("async",scriptNode.getAttribute("async"));else newScript.async=false;if(scriptNode.hasAttribute("defer"))newScript.setAttribute("defer",scriptNode.getAttribute("defer"));else newScript.defer=false;scriptNode.parentNode.replaceChild(newScript,scriptNode)}}function getEditableConfigNode(path){var node=document.querySelectorAll('cq[data-path\x3d"'+path+'"]');return node.length?
node[0]:null}function getEditableNode(path){var node=getEditableConfigNode(path);return node?node.parentNode:null}function htmlToNode(html){var wrapper=document.createElement("div");wrapper.innerHTML=html;return wrapper.firstElementChild}function htmlToNodeArray(html){var wrapper=document.createElement("div");wrapper.innerHTML=html;var newNodes=[],kids=wrapper.childNodes;for(var i=0;i<kids.length;i++)if(kids[i].nodeType===1||kids[i].nodeType===8)newNodes.push(kids[i]);return newNodes}function executeScript(node){if(node.nodeName===
"SCRIPT")sanitize(node.innerHTML);else{var arr=node.getElementsByTagName("script");for(var n=0;n<arr.length;n++)if(arr[n].src&&arr[n].src.length)loadScript(arr[n]);else if(arr[n].type===""||arr[n].type==="text/javascript"||arr[n].type==="text/ecmascript"||arr[n].type==="application/javascript"||arr[n].type==="application/ecmascript")sanitize(arr[n].innerHTML)}}var HTMlCommand=ns.util.extendClass(ns.AbstractCommand,{replace:function(path,msg){var node=getEditableNode(path),parent=node?node.parentNode:
null,newNode=htmlToNode(msg.data);if(parent){parent.replaceChild(newNode,node);executeScript(newNode);manipulationEnd()}},replaceContent:function(path,msg){var editableNode=getEditableNode(path),parent=editableNode?editableNode.parentNode:null,contentNodes=htmlToNodeArray(msg.data),cfgNode=getEditableConfigNode(path);cfgNode=editableNode.removeChild(cfgNode);editableNode.innerHTML="";if(parent){for(var i=0;i<contentNodes.length;i++){var newNode=contentNodes[i];editableNode.appendChild(newNode);executeScript(newNode)}editableNode.appendChild(cfgNode);
manipulationEnd()}},insertBefore:function(path,msg){var node=getEditableNode(path),parent=node?node.parentNode:null,newNode=htmlToNode(msg.data);if(parent){newNode=parent.insertBefore(newNode,node);executeScript(newNode);manipulationEnd()}},insertAfter:function(path,msg){var node=getEditableNode(path),nextNode=node.nextSibling,parent=node?node.parentNode:null,newNode=htmlToNode(msg.data);if(parent&&nextNode){newNode=parent.insertBefore(newNode,nextNode);executeScript(newNode);manipulationEnd()}},
insertLast:function(path,msg){var node=getEditableNode(path),newNode=htmlToNode(msg.data);if(node){newNode=node.appendChild(newNode);executeScript(newNode);manipulationEnd()}},toggleClass:function(path,msg){var cmd=msg.data,target;if(path)target=getEditableNode(path);else target=cmd.selector?document.querySelectorAll(cmd.selector)[0]:document.documentElement;this._toggleClassName(target,cmd)}});HTMlCommand.prototype["delete"]=function(path,msg){var node=getEditableNode(path),parent=node?node.parentNode:
null;if(parent){parent.removeChild(node);manipulationEnd()}};ns.commands["HTML"]=new HTMlCommand;Granite.author.command=Granite.author.command||{};Granite.author.command=ns.commands["HTML"];self.getEditableConfigNode=getEditableConfigNode;self.htmlToNode=htmlToNode;self.getEditableNode=getEditableNode;self.htmlToNodeArray=htmlToNodeArray;self.executeScript=executeScript})(this,window.Granite.author);
(function(window,ns,undefined){ns.commands=ns.commands||{};function getDataPath(path){return path?path.replace(/^(.)*\/jcr:content\//,""):""}function getPagePath(path){return path?path.replace(/\/jcr:content.*/,""):""}function updatePageModel(msg){if(msg&&msg.path){msg.pagePath=getPagePath(msg.path);msg.dataPath=getDataPath(msg.path)}if(msg&&msg.data&&msg.data.sibling)msg.data.sibling=getDataPath(msg.data.sibling);window.dispatchEvent(new CustomEvent("cq-pagemodel-update",{detail:{msg:msg}}))}var JSONCommand=
ns.util.extendClass(ns.AbstractCommand,{replace:function(path,msg){updatePageModel(msg)},replaceContent:function(path,msg){updatePageModel(msg)},insertBefore:function(path,msg){updatePageModel(msg)},insertAfter:function(path,msg){updatePageModel(msg)},insertLast:function(path,msg){updatePageModel(msg)},moveBefore:function(path,msg){updatePageModel(msg)},moveAfter:function(path,msg){updatePageModel(msg)},toggleClass:function(path,msg){var cmd=msg.data,target;if(path)target=document.querySelector("[data-cq-data-path\x3d'"+
getDataPath(path)+"']");else target=cmd.selector?document.querySelector(cmd.selector):document.documentElement;this._toggleClassName(target,cmd)}});JSONCommand.prototype["delete"]=function(path,msg){updatePageModel(msg)};ns.commands["JSON"]=new JSONCommand})(this,window.Granite.author);
(function(window,undefined){var self=Granite.author||{};self.commands=self.commands||{};window.location.origin=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");function executeCommand(command,req){if(!command||!req||!req.data)return;if(command[req.data.cmd])if(command[req.data.cmd](req.data.path,{"cqauthor":req.id,"cmd":req.data.cmd,"pagePath":req.data.pagePath,"dataPath":req.data.dataPath,"path":req.data.path,
"data":req.data.cmdData,"respond":req.respond.bind(req)})!==false)req.respond("cqauthor-cmd",{path:req.data.path,cmdData:req.data||{}})}function receiveMessage(req){if(!req)return;executeCommand(self.commands[req.data.dataType||"HTML"],req)}self.inner.EditorFrame.subscribeRequestMessage("cqauthor-cmd",receiveMessage)})(this);
(function(window,undefined){function reposition(){Granite.author.inner.EditorFrame.postMessage("cq-contentframe-layout-change",null,-1)}var observer=new MutationObserver(reposition);document.addEventListener("DOMContentLoaded",function(ev){observer.observe(document.body,{attributes:true,childList:true,characterData:true,subtree:true});document.addEventListener("load",reposition,true);window.addEventListener("resize",reposition,true)})})(this);
(function(window,undefined){Granite.author.command=Granite.author.command||{};Granite.author.command["requestFragmentIdentifierChanges"]=function(){var hashChangeDetected=function(){var fragmentIdentifierPath=window.location.hash;if(fragmentIdentifierPath.indexOf("#")===0)fragmentIdentifierPath=fragmentIdentifierPath.substring(1);Granite.author.inner.EditorFrame.postMessage("cq-contentframe-fragment-identifier-change",{path:fragmentIdentifierPath},-1)};window.addEventListener("hashchange",hashChangeDetected,
false);hashChangeDetected()}})(this);